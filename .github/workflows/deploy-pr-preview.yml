name: PREVIEW PR - Deploy

env:
  HUSKY: 0

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

concurrency:
  group: pr-preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  deploy-pr-preview:
    if: ${{ github.event.action != 'closed' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Uncloud CLI
        run: |
          curl -fsS https://get.uncloud.run/install.sh | sh
          uc --version

      - name: Setup SSH
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.UNCLOUD_SSH_KEY }}" > ~/.ssh/id_ecdsa
          chmod 600 ~/.ssh/id_ecdsa
          # Extract the host from the UNCLOUD_CONNECT secret
          host="$(echo "${{ secrets.UNCLOUD_CONNECT }}" | sed -E 's#^ssh(\+cli)?://##; s#^[^@]+@##; s#:/.*##; s#:.*##')"
          ssh-keyscan -H "$host" >> ~/.ssh/known_hosts

      - name: Render Compose for PR
        shell: bash
        env:
          PR_ID: ${{ github.event.pull_request.number }}
          UNCLOUD_PREVIEW_DOMAIN: ${{ vars.UNCLOUD_PREVIEW_DOMAIN }}
        run: |
          set -euo pipefail
          POSTGRES_PASSWORD=$(openssl rand -base64 32)
          MINIO_ROOT_PASSWORD=$(openssl rand -base64 32)
          JWT_SECRET=$(openssl rand -base64 32)
          JWT_REFRESH_SECRET=$(openssl rand -base64 32)
          PREVIEW_MAILHOG_DOMAIN="mailhog-pr-${PR_ID}.${UNCLOUD_PREVIEW_DOMAIN}"
          PREVIEW_WEB_DOMAIN="pr-${PR_ID}.${UNCLOUD_PREVIEW_DOMAIN}"
          PREVIEW_API_DOMAIN="api-pr-${PR_ID}.${UNCLOUD_PREVIEW_DOMAIN}"
          export PR_ID PREVIEW_WEB_DOMAIN PREVIEW_API_DOMAIN PREVIEW_MAILHOG_DOMAIN POSTGRES_PASSWORD MINIO_ROOT_PASSWORD JWT_SECRET JWT_REFRESH_SECRET
          sed "s/__PR_ID__/${PR_ID}/g" docker-compose.preview.tpl.yml > /tmp/docker-compose.pr.yml
          # envsubst '${PR_ID}' < "docker-compose.preview.tpl.yml" > /tmp/docker-compose.pr.yml
          # mv docker-compose.preview.tpl.yml /tmp/docker-compose.pr.yml

      - name: Deploy PR Preview stack
        env:
          PR_ID: ${{ github.event.pull_request.number }}
          UNCLOUD_CONNECT: ${{ secrets.UNCLOUD_CONNECT }}
          UNCLOUD_PREVIEW_DOMAIN: ${{ vars.UNCLOUD_PREVIEW_DOMAIN }}
        run: |
          set -euo pipefail
          POSTGRES_PASSWORD=$(openssl rand -base64 32)
          MINIO_ROOT_PASSWORD=$(openssl rand -base64 32)
          JWT_SECRET=$(openssl rand -base64 32)
          JWT_REFRESH_SECRET=$(openssl rand -base64 32)
          PREVIEW_MAILHOG_DOMAIN="mailhog-pr-${PR_ID}.${UNCLOUD_PREVIEW_DOMAIN}"
          PREVIEW_WEB_DOMAIN="pr-${PR_ID}.${UNCLOUD_PREVIEW_DOMAIN}"
          PREVIEW_API_DOMAIN="api-pr-${PR_ID}.${UNCLOUD_PREVIEW_DOMAIN}"
          export PR_ID PREVIEW_WEB_DOMAIN PREVIEW_API_DOMAIN PREVIEW_MAILHOG_DOMAIN POSTGRES_PASSWORD MINIO_ROOT_PASSWORD JWT_SECRET JWT_REFRESH_SECRET

          # master_key
          MASTER_KEY=$(echo -n "preview-pr-${PR_ID}" | openssl dgst -sha256 -binary | head -c 32 | openssl base64)
          export MASTER_KEY
          uc deploy -f /tmp/docker-compose.pr.yml -y

      - name: Comment PR - send message to PR preview link
        env:
          PR_ID: ${{ github.event.pull_request.number }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UNCLOUD_PREVIEW_DOMAIN: ${{ vars.UNCLOUD_PREVIEW_DOMAIN }}
        run: |
          set -euo pipefail
          PREVIEW_WEB_DOMAIN="https://pr-${PR_ID}.${UNCLOUD_PREVIEW_DOMAIN}"
          PREVIEW_API_DOMAIN="https://api-pr-${PR_ID}.${UNCLOUD_PREVIEW_DOMAIN}"
          body=$(jq -n --arg w "$PREVIEW_WEB_DOMAIN" --arg a "$PREVIEW_API_DOMAIN" \
            '{body: ("âœ… Preview ready:\n- Web: " + $w + "\n- API: " + $a)}')
          curl -sS -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Accept: application/vnd.github+json" \
            "${{ github.api_url }}/repos/${{ github.repository }}/issues/${PR_ID}/comments" \
            -d "$body"

  cleanup-pr-preview:
    if: ${{ github.event.action == 'closed' }}
    runs-on: ubuntu-latest

    steps:
      - name: Install Uncloud CLI
        run: |
          curl -fsS https://get.uncloud.run/install.sh | sh
          uc --version

      - name: Setup SSH
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.UNCLOUD_SSH_KEY }}" > ~/.ssh/id_ecdsa
          chmod 600 ~/.ssh/id_ecdsa
          # Extract the host from the UNCLOUD_CONNECT secret
          host="$(echo "${{ secrets.UNCLOUD_CONNECT }}" | sed -E 's#^ssh(\+cli)?://##; s#^[^@]+@##; s#:/.*##; s#:.*##')"
          ssh-keyscan -H "$host" >> ~/.ssh/known_hosts

      - name: Cleanup PR Preview stack
        env:
          UNCLOUD_CONNECT: ${{ secrets.UNCLOUD_CONNECT }}
          PR_ID: ${{ github.event.pull_request.number }}
          UNCLOUD_PREVIEW_DOMAIN: ${{ vars.UNCLOUD_PREVIEW_DOMAIN }}
        run: |
          set -euo pipefail
          # render compose as deployment does:
          POSTGRES_PASSWORD=""
          MINIO_ROOT_PASSWORD=""
          JWT_SECRET=""
          JWT_REFRESH_SECRET=""
          PREVIEW_WEB_DOMAIN="pr-${PR_ID}.${UNCLOUD_PREVIEW_DOMAIN}"
          PREVIEW_API_DOMAIN="api-pr-${PR_ID}.${UNCLOUD_PREVIEW_DOMAIN}"
          PREVIEW_MAILHOG_DOMAIN="mailhog-pr-${PR_ID}.${UNCLOUD_PREVIEW_DOMAIN}"
          export PR_ID PREVIEW_WEB_DOMAIN PREVIEW_API_DOMAIN PREVIEW_MAILHOG_DOMAIN POSTGRES_PASSWORD MINIO_ROOT_PASSWORD JWT_SECRET JWT_REFRESH_SECRET
          sed "s/__PR_ID__/${PR_ID}/g" docker-compose.preview.tpl.yml > /tmp/docker-compose.pr.yml
          # envsubst '${PR_ID}' < "docker-compose.preview.tpl.yml" > /tmp/docker-compose.pr.yml
          # mv docker-compose.preview.tpl.yml /tmp/docker-compose.pr.yml
          # collect services and volumes:
          services="$(yq -r '.services | keys | .[]' /tmp/docker-compose.pr.yml)"
          volumes="$(yq -r '.volumes | keys | .[]' /tmp/docker-compose.pr.yml)"
          echo "$services" | xargs -r uc rm || true
          echo "$volumes" | xargs -r uc volume rm -y || true