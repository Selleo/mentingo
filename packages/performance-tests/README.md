# Mentingo Performance Testing Suite

Comprehensive k6 performance testing suite for the Mentingo API designed to simulate realistic load scenarios with concurrent users.

## Overview

This package contains performance and load testing scripts that simulate various user scenarios against the Mentingo API. It includes:

- **Load Testing**: Sustained traffic at target load
- **Stress Testing**: Gradual increase to find system limits
- **Spike Testing**: Sudden traffic surges to test recovery
- **Soak Testing**: Extended duration tests for stability
- **Mixed Workload**: Realistic user journey combining multiple endpoints

## Prerequisites

- **Node.js** 16+ and **pnpm**
- **k6** installed globally: `brew install k6` (macOS) or [download](https://k6.io/docs/getting-started/installation/)
- Access to a running Mentingo API instance
- Test user accounts created in the target environment

## Installation

### Install k6

```bash
# macOS
brew install k6

# Windows (using Chocolatey)
choco install k6
```

### Configure Environment

From the monorepo root or from this package directory:

```bash
cd packages/performance-tests
cp .env.example .env
```

Edit `.env` with your target environment details:

```env
# Local development
ENVIRONMENT=local
API_BASE_URL=http://localhost:3000

# Or staging/production
ENVIRONMENT=staging
API_BASE_URL=https://your-url-here
```

## Running Tests

All commands should be run from the **monorepo root** or from the **performance-tests package directory**.

### From Monorepo Root

```bash
# Run from root using pnpm
pnpm --filter @mentingo/performance-tests test:load
pnpm --filter @mentingo/performance-tests test:stress
pnpm --filter @mentingo/performance-tests test:spike
pnpm --filter @mentingo/performance-tests test:soak
```

### From Package Directory

```bash
cd packages/performance-tests

# Load Test
pnpm test:load

# Stress Test
pnpm test:stress

# Spike Test
pnpm test:spike

# Soak Test
pnpm test:soak

# Mixed Workload
pnpm test:mixed

# Load Test with Dashboard
pnpm test:load:dashboard
```

## Test Scenarios

### Load Test (Sustained Users)

```bash
pnpm test:load
```

- Ramps up gradually to target user count
- Sustains load for configured duration
- Monitors response times and error rates
- **Duration**: Configurable via `.env`

### Stress Test (Find Breaking Point)

```bash
pnpm test:stress
```

- Progressively increases load in stages
- Identifies system limits and degradation points
- **Duration**: Configurable via `.env`

### Spike Test (Sudden Surge)

```bash
pnpm test:spike
```

- Rapid spike from idle to peak users
- Tests system recovery and resilience
- **Duration**: Configurable via `.env`

### Soak Test (Extended Stability)

```bash
pnpm test:soak
```

- Sustains moderate load for extended period
- Detects memory leaks, connection issues, degradation
- **Duration**: Configurable via `.env` (default: 2 hours)

### Load Test with Dashboard

```bash
pnpm test:load:dashboard
```

Open `http://localhost:5665` to view the live dashboard. Metrics update every 1 second.

## Running Tests on K6 Cloud

K6 Cloud provides distributed load testing from multiple geographic locations with real-time analytics.

### Setup K6 Cloud

1. **Create K6 Cloud Account**: Sign up at [app.k6.io](https://app.k6.io)

2. **Get API Token**:

   - Go to Settings → API Token in K6 Cloud dashboard
   - Copy your token

3. **Authenticate K6 CLI**:

   ```bash
   k6 login cloud --token YOUR_K6_CLOUD_TOKEN
   ```

4. **Configure Cloud Settings** in `.env`:
   ```env
   K6_CLOUD_TOKEN=your_k6_cloud_token
   K6_CLOUD_PROJECT_ID=your_project_id
   K6_CLOUD_TEST_NAME="Mentingo Load Test"
   ```

### ⚠️ IMPORTANT: Update Your .env for Cloud Testing

K6 Cloud **CANNOT access localhost**! Update your `.env` file:

```env
# ❌ This will NOT work on K6 Cloud:
API_BASE_URL=http://localhost:3000

# ✅ Use a publicly accessible URL:
API_BASE_URL=https://your-staging-api.com
ENVIRONMENT=staging
```

### Run Tests on Cloud

```bash
# From package directory
pnpm test:load:cloud
pnpm test:stress:cloud
pnpm test:spike:cloud
pnpm test:soak:cloud
pnpm test:mixed:cloud
```

## Configuration

All test parameters are configurable via environment variables in `.env`:

### Test User Configuration

The tests use **seeded users** generated by the bulk user seeder. Configure the counts to match your database:

```env
SEEDED_USER_PASSWORD=password
SEEDED_STUDENT_COUNT=1000
SEEDED_ADMIN_COUNT=100
SEEDED_CREATOR_COUNT=100
```

### Performance Thresholds

Adjust performance expectations:

```env
THRESHOLD_P95_MS=500          # 95th percentile response time
THRESHOLD_P99_MS=1000         # 99th percentile response time
THRESHOLD_MAX_MS=5000         # Maximum response time
THRESHOLD_ERROR_RATE=0.01     # Maximum error rate (1%)
THRESHOLD_CHECK_RATE=0.99     # Minimum check pass rate (99%)
```

### Load Test Configuration

```env
LOAD_TEST_RAMP_UP_DURATION=2m      # Time to ramp up
LOAD_TEST_SUSTAIN_DURATION=3m      # Time at peak load
LOAD_TEST_RAMP_DOWN_DURATION=2m    # Time to ramp down
LOAD_TEST_MAX_VUS=20               # Peak virtual users
```

## Test Data Requirements

### Bulk User Seeding

Before running performance tests, ensure you have seeded users in your database:

```bash
# From the API directory
pnpm db:seed-bulk
```

This creates:

- Students: `user+student+1@example.com` to `user+student+N@example.com`
- Admins: `user+admin+1@example.com` to `user+admin+N@example.com`
- Content Creators: `user+creator+1@example.com` to `user+creator+N@example.com`

All with the password configured in `SEEDED_USER_PASSWORD`.

## Project Structure

```
packages/performance-tests/
├── config/
│   ├── environments.js      # Environment configurations
│   └── thresholds.js        # Performance thresholds
├── src/
│   ├── scenarios/           # Test scenarios
│   │   ├── load-test.js
│   │   ├── stress-test.js
│   │   ├── spike-test.js
│   │   └── soak-test.js
│   ├── tests/               # Test implementations
│   │   ├── auth.test.js
│   │   ├── courses.test.js
│   │   └── mixed-workload.test.js
│   └── utils/               # Helper utilities
│       ├── auth.js
│       ├── check-helpers.js
│       └── data-generators.js
├── .env.example             # Example environment config
├── package.json
└── README.md
```

## User Journeys

Tests simulate realistic user behavior:

### Student Journey (60% of traffic)

1. Login
2. Browse available courses
3. Enroll in a course
4. View course details

### Admin Journey (25% of traffic)

1. Login as admin
2. View all courses
3. Check course statistics
4. Review student progress

### Content Creator Journey (15% of traffic)

1. Login as creator
2. View own courses
3. Check course statistics
4. Analyze engagement

## Interpreting Results

### Key Metrics

- **http_req_duration**: Response time (p95, p99, max)
- **http_req_failed**: Error rate (should be < 1%)
- **checks**: Assertion pass rate (should be > 99%)
- **iterations**: Number of complete user journeys
- **vus**: Virtual users (concurrent users)

### Thresholds

Tests will **fail** if thresholds are exceeded:

- ✅ **Passed**: All metrics within thresholds
- ❌ **Failed**: One or more thresholds exceeded

### Example Output

```
     ✓ login successful
     ✓ response time acceptable
     ✓ has user data

     checks.........................: 99.85% ✓ 15234 ✗ 23
     data_received..................: 45 MB  150 kB/s
     data_sent......................: 12 MB  40 kB/s
     http_req_duration..............: avg=234ms min=45ms med=198ms max=1.2s p(90)=412ms p(95)=478ms
     http_req_failed................: 0.12%  ✓ 18 ✗ 15216
     iterations.....................: 3425   11.4/s
     vus............................: 20     min=0 max=20
```

## Troubleshooting

### k6 not found

Install k6 globally: `brew install k6` or see [k6 installation](https://k6.io/docs/getting-started/installation/)

### Connection refused

- Verify API is running: `curl http://localhost:3000/api/healthcheck`
- Check `API_BASE_URL` in `.env`

### High error rates

- Check if seeded users exist in database
- Verify `SEEDED_USER_PASSWORD` matches database
- Check API logs for errors

### Cloud tests fail immediately

- Ensure `API_BASE_URL` is publicly accessible (not localhost)
- Verify k6 cloud authentication: `k6 login cloud`

## Integration with Monorepo

This package integrates with the Mentingo monorepo:

- **Workspace**: Defined in root `pnpm-workspace.yaml`
- **Run from root**: `pnpm --filter @mentingo/performance-tests <script>`
- **Shared configs**: Can reference types from `@mentingo/shared` if needed
